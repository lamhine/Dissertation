---
title: "Add Health Wave 4 Data Cleaning"
author: "Tracy Lam-Hine"
date: "12/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load packages
```{r eval = F}
   library(foreign)
   library(dplyr)
   library(tidyr)
   library(stringr)
   library(table1)
   library(tableone)
   library(visdat)
   library(naniar)
   library(ggplot2)
   library(lme4)
```

## Set working directory
```{r eval = F}
setwd("C:/Users/lamhine/Desktop")
```

## Read in data files
```{r eval = F}
# wave 4
wave4 <-
  read.xport(
    "C:/Users/lamhine/Desktop/AddHealth/Core Files - Wave IV/Wave IV In Home Interview Data/wave4/wave4.xpt"
  )


# biomarker data
glu_a1c <-
  read.xport(
    "C:/Users/lamhine/Desktop/AddHealth/Wave IV Biomarker Files/Wave IV Glucose/glu_a1c.xpt"
  )
lipids <-
  read.xport(
    "C:/Users/lamhine/Desktop/AddHealth/Wave IV Biomarker Files/Wave IV Lipids/lipids.xpt"
  )
w4meds <-
  read.xport(
    "C:/Users/lamhine/Desktop/AddHealth/Wave IV Biomarker Files/Wave IV Medication File/w4meds.xpt"
  )


# weights
w1wts <-
  read.xport(
    "C:/Users/lamhine/Desktop/AddHealth/Core Files - Wave I/Wave I In-Home Weights/Homewt1.xpt"
  )
w4wts <-
  read.xport(
    "C:/Users/lamhine/Desktop/AddHealth/Core Files - Wave IV/Wave IV Grand Sample Weights/weights4/weights4.xpt"
  )

```
  
## WAVE 4 DATA
```{r}        
# pull necessary variables from wave 4 data
w4 <- wave4 %>% 
  select(
    AID,
    IYEAR4,                         # wave 4 interview year
    BIO_SEX4,                       # biological sex
    H4OD1Y,                         # birth year
    H4MA1,                          # emotional abuse
    H4WP3, H4WP9, H4WP16, H4WP30,   # family member incarceration
    H4ID5H, H4MH18:H4MH27,          # depression
    H4MH29,                         # experiences of discrimination
    H4SE1,                          # suicidal ideation
    H4SBP,                          # systolic BP
    H4DBP,                          # diastolic BP
    H4BMI,                          # BMI
    H4BMICLS,                       # BMI categorized
    H4WAIST,                        # waist circumference
    H4ID5B,                         # dx hyperlipids
    H4ID5C,                         # dx hypertension
    H4ID5D,                         # dx hyperglycemia
    H4ID5F,                         # dx asthma
    H4ID5J,                         # dx anxiety
    H4TO63,                         # prescription drug abuse
    H4TO65C:H4TO65E, H4TO66,        # illicut drug use other than cannabis
    H4TR7                           # currently pregnant
  )
```

## Calculate age at wave 4
```{r}
w4 <- w4 %>% 
  mutate(age_w4 = IYEAR4 - H4OD1Y) %>% 
  select(!IYEAR4) %>% 
  select(!H4OD1Y)
```

## Create emotional abuse ACE variable
```{r}
w4 <- w4 %>%
  mutate(
    ace_emo_abu_w4 = NA_real_,
    ace_emo_abu_w4 = case_when(
      H4MA1 %in% c(1, 2, 3, 4, 5) ~ 1,
      H4MA1 == 6                  ~ 0,
      TRUE                    ~ NA_real_
    ),
    ace_emo_abu_w4 = factor(
      ace_emo_abu_w4,
      levels = c(0,1),
      labels = c("Did not experience emotional abuse",
                 "Experienced emotional abuse" 
                 )
      )
  )

w4 <- w4 %>% 
  select(!H4MA1)
```


## Create parental incarceration ACE variable
```{r}
w4 <- w4 %>%
  mutate(
    ace_par_inc_w4 = NA_real_,
    ace_par_inc_w4 = case_when(
      H4WP3 == 1 | H4WP9 == 1 | H4WP16 == 1 | H4WP30 == 1 ~ 1,
      H4WP3 == 0 | H4WP9 == 0 | H4WP16 == 0 | H4WP30 == 0 ~ 0,
      TRUE                                                ~NA_real_
    ),
    ace_par_inc_w4 = factor(
      ace_par_inc_w4,
      levels = c(0,1),
      labels = c("No family members incarcerated",
                 "Family member incarcerated" 
                 )
      )
  )

w4 <- w4 %>% 
  select(!H4WP3:H4WP30)
```

## Recode depression (binary) variable and cts outcome
```{r}
#H4ID5H, H4MH18:H4MH27
#https://journals.plos.org/plosone/article/file?id=10.1371/journal.pone.0148373&type=printable

sel <- c("H4ID5H", "H4MH18", "H4MH19", "H4MH20", "H4MH21", "H4MH22", 
         "H4MH23", "H4MH24", "H4MH25", "H4MH26", "H4MH27")
w4[sel] <- lapply(w4[sel], function(x) replace(x,x %in% c(6,8), NA_real_) )
sel <- c("H4MH18", "H4MH19", "H4MH20", "H4MH21", "H4MH22", 
         "H4MH23", "H4MH24", "H4MH25", "H4MH26", "H4MH27")

w4 <- w4 %>%
  mutate(
    H4MH20 = -1*H4MH20 + 3,
    H4MH24 = -1*H4MH24 + 3,
    H4MH25 = -1*H4MH25 + 3,
    dep_cts = rowSums(select(., .dots = all_of(sel)), na.rm = T)
  )


w4 <- w4 %>% 
  select(!H4MH18:H4MH27)

```

## Create suicidal ideation outcome
```{r}
w4 <- w4 %>% 
  mutate(H4SE1 = na_if(H4SE1, 6),
         H4SE1 = na_if(H4SE1, 7),
         H4SE1 = na_if(H4SE1, 8)) %>% 
  rename(sui_w4 = H4SE1) %>% 
  mutate(
    sui_w4 = factor(
      sui_w4, 
      levels = c(0,1),
      labels = c("Not contemplated suicide in last 12 months",
                 "Seriously contemplated suicide in last 12 months"
                 )
  ))
```

## Create problematic drug use outcome
```{r}
#H4TO63, H4TO65C:H4TO65E, H4TO66

w4 <- w4 %>% 
  mutate(
    pdu_w4 = NA_real_,
    pdu_w4 = case_when(
      H4TO63 == 1 | H4TO65C == 1 | H4TO65D == 1 | H4TO65E == 1 | H4TO66 == 1 ~ 1,
      H4TO63 == 0 & H4TO65C == 0 & H4TO65D == 0 & H4TO65E == 0 & H4TO66 != 1 ~ 0,
      TRUE ~ NA_real_),
    pdu_w4 = factor(
      pdu_w4,
      levels = c(0,1),
      labels = c("Has not abused prescription or illegal drugs",
                 "Has abused prescription or illegal drugs"
                 )
      )
  ) %>%
  select(!c(H4TO63, H4TO65C:H4TO65E, H4TO66))
```

## Create ever dx with asthma outcome
```{r}
w4 <- w4 %>% 
  mutate(H4ID5F = na_if(H4ID5F, 6)) %>% 
  rename(ast_w4 = H4ID5F) %>% 
  mutate(
    ast_w4 = factor(
      ast_w4,
      levels = c(0,1),
      labels = c("Not diagnosed with asthma",
                 "Diagnosed with asthma"
                 )
      )
    )
```

## Create ever dx with anxiety outcome
```{r}
w4 <- w4 %>% 
  mutate(H4ID5J = na_if(H4ID5J, 6)) %>% 
  rename(anx_w4 = H4ID5J) %>% 
  mutate(
    anx_w4 = factor(
      anx_w4,
      levels = c(0,1),
      labels = c("Not diagnosed with anxiety",
                 "Diagnosed with anxiety"
                 )
    )
  )
```

## Recode experiences of discrimination variable
```{r}
w4 <- w4 %>%
  mutate(
    exp_dis_w4 = NA_real_,
    exp_dis_w4 = case_when(H4MH29 %in% c(1, 3, 7) ~ 1,
                         H4MH29 %in% c(96, 98)  ~ NA_real_,
                         TRUE                   ~ 0),
    exp_dis_w4 = factor(
      exp_dis_w4,
      levels = c(0,1),
      labels = c("Did not dexperience racial discrimination",
                 "Experienced racial discrimination"
                 )
    )
  )
    
w4 <- w4 %>% 
  select(!H4MH29)
```

## Recode biomeasures
```{r}
w4 <- w4 %>%
  mutate(
    # biological sex
    BIO_SEX4 = factor(
      BIO_SEX4,
      levels = c(1,2),
      labels = c("Male",
                 "Female")
    ),
    
    # systolic blood pressure
    sbp_w4 = NA_real_,
    sbp_w4 = case_when(H4SBP %in% c(996, 997, 999) ~ NA_real_,
                    TRUE ~ H4SBP),
    
    # diastolic blood pressure
    dbp_w4 = NA_real_,
    dbp_w4 = case_when(H4DBP %in% c(996, 997, 999) ~ NA_real_,
                    TRUE ~ H4DBP),
    
    # diagnosed hypertension
    dx_ht_w4 = NA_real_,
    dx_ht_w4 = case_when(H4ID5C %in% c(6, 8) ~ NA_real_,
                      TRUE ~ H4ID5C),
    dx_ht_w4 = factor(
      dx_ht_w4,
      levels = c(0,1),
      labels = c("Not diagnosed with hypertension",
                 "Diagnosed with hypertension"
                 )
    ),
    
    # waist circumference
    waist_w4 = NA_real_,
    waist_w4 = case_when(
      H4WAIST %in% c(996, 997, 999) ~ NA_real_,
      TRUE ~ H4WAIST
                      ),
    
    # diagnosed high cholesterol
    dx_hc_w4 = NA_real_,
    dx_hc_w4 = case_when(H4ID5B %in% c(6, 8) ~ NA_real_,
                      TRUE ~ H4ID5B),
    dx_hc_w4 = factor(
      dx_hc_w4,
      levels = c(0,1),
      labels = c("Not diagnosed with high cholesterol",
                 "Diagnosed with high cholesterol"
                 )
    ),
    
    # diagnosed high blood sugar / diabetes
    dx_hbs_w4 = NA_real_,
    dx_hbs_w4 = case_when(H4ID5D == 6 ~ NA_real_,
                       TRUE ~ H4ID5D),
    dx_hbs_w4 = factor(
      dx_hbs_w4,
      levels = c(0,1),
      labels = c("Not diagnosed with diabetes",
                 "Diagnosed with diabetes"
                 )
    )
  )

w4 <- w4 %>% 
  select(!H4SBP:H4ID5D)
```       

## INDICATOR FOR HT MED USE
```{r} 
# spread w4meds file from long to wide
meds <- w4meds
meds <- meds %>% select(-'MED_TOT')
meds_long <- gather(meds, set, name, SET1:SET4, factor_key = T)

# check <- meds_long %>% group_by(AID) %>% summarize(n = n()) #checks out
# rm(check)

# create list of antihypertensive medication codes
ht_meds_w4 <-  c(
  "040-042",     # ACE-INHIBITORS
  "040-043",     # ANTI-ADRENERGICS
  "040-044",     # ANTI-ADRENERGICS
  "040-047",     # BETA-BLOCKERS
  "040-048",     # CALCIUM CHANNEL BLOCKERS
  "040-049-156", # THIAZIDE DIURETICS
  "040-053",     # VASODILATORS
  "040-055",     # COMBO ANTI-HYPERTENSIVES
  "040-056")     # AT2 RECEPTOR BLOCKERS

# create new 'htn_med_use' column that indicates use of any of htn_meds codes
meds_long <- meds_long %>%
  mutate(
    ht_med_use_w4 = NA_real_,
    ht_med_use_w4 = case_when(
      str_detect(
        name, paste(ht_meds_w4, collapse = "|")) ~ 1,
        TRUE                                     ~ 0
      )
    )

# summarize count of htn meds by AID in table and transform to binary
meds_w4 <- meds_long %>%
  group_by(AID) %>%
  summarize(
    ht_meds_w4 = sum(
      ht_med_use_w4, 
      na.rm = T
      )
    )

meds_w4 <- meds_w4 %>%
  mutate(
    ht_meds_w4 = case_when(
      ht_meds_w4 == 0 ~ ht_meds_w4,
      TRUE ~ 1
      ),
    ht_meds_w4 = factor(
      ht_meds_w4, 
      levels = c(0,1),
      labels = c("No anti-hypertension medication use",
                 "Anti-hypertension medication use"
                 )
      )
    )
```
 
 
## BIOMARKER DATA
```{r}       
# join biomarker files
bio <- full_join(glu_a1c, lipids, by = "AID")
bio <- bio %>%
  select(AID, TG, HDL, C_MED2, HBA1C, C_MED)

# recode missing biomarker data
bio <- bio %>%
  mutate(
    # triglyceride deciles
    tg_dec_w4 = NA_real_,
    tg_dec_w4 = case_when(
      TG == 99 ~ NA_real_,
      TRUE ~ TG
      ),
    
    # HDL cholesterol deciles
    hdl_dec_w4 = NA_real_,
    hdl_dec_w4 = case_when(
      HDL == 99 ~ NA_real_,
      TRUE ~ HDL
      ),
    
    # HBA1C percentage
    hba1c_pct_w4 = NA_real_,
    hba1c_pct_w4 = case_when(
      HBA1C == 99 ~ NA_real_,
      TRUE ~ HBA1C
      ),
    
    # anti-diabetes medication use
    C_MED = factor(
      C_MED,
      levels = c(0,1),
      labels = c("No anti-diabetes medication use",
                 "Anti-diabetes medication use"
                 )
      ),
    
    # anti-hyperlipid medication use
    C_MED2 = factor(
      C_MED2, 
      levels = c(0,1),
      labels = c("No anti-hyperlipid medication use",
                 "Anti-hyperlipid medication use"
                 )
      )
  )
```       
       
## COMBINE W4, BIOMARKERS, AND MEDS FILES WITH LEFT JOINS 
```{r}     
# left join w4 and biomarker files
w4 <- w4 %>% left_join(bio, by = "AID")

# left join ah and meds files
w4 <- w4 %>% left_join(meds_w4, by = "AID")
```       
       
## CREATE METS VARIABLE
```{r}
# create mets component variables
w4 <- w4 %>%
  mutate(
    # blood pressure: >= 130 sbp, >= 80 dbp, dx ht, or ht rx use
    # else if normotensive and missing either dx_ht or ht_meds ~ 0
    # else if missing any of sbp, dbp, dx_ht, or ht_meds ~ NA
    # else ~ 0
    mets_bp = NA_real_,
    mets_bp = case_when(
      sbp_w4 >= 130 | dbp_w4 >= 80  | dx_ht_w4 == 1   | ht_meds_w4 == 1   ~ 1,
      sbp_w4 <  130 & dbp_w4 < 80 & is.na(dx_ht_w4)                       ~ 0,
      sbp_w4 <  130 & dbp_w4 < 80 & is.na(ht_meds_w4)                     ~ 0,
      is.na(sbp_w4) | is.na(dbp_w4) | is.na(dx_ht_w4) | is.na(ht_meds_w4) ~ NA_real_,
      TRUE                                                                ~ 0
    ),
    
    # waist circumference >= 88cm (F) or >= 102cm (M)
    # else if missing waist ~ NA
    # else ~ 0.
    mets_waist = NA_real_,
    mets_waist = case_when(
      as.double(BIO_SEX4) == 1 & waist_w4 >= 102 ~ 1,
      as.double(BIO_SEX4) == 2 & waist_w4 >= 88  ~ 1,
      is.na(waist_w4)                 ~ NA_real_,
      TRUE                            ~ 0
    ),
    
    # triglycerides: top 2 deciles (F) or top 3 deciles (M) ~ 1
    # else if taking anti hyperlipid medication ~ 1
    # else if missing both tg_dec and C_MED2 ~ NA
    # else ~ 0. check: table(w4$C_MED2, w4$tg_dec, exclude = NULL)
    mets_tg = NA_real_,
    mets_tg = case_when(
      as.double(BIO_SEX4) == 1 & tg_dec_w4 %in% c(8:10) ~ 1,
      as.double(BIO_SEX4) == 2 & tg_dec_w4 %in% c(9:10) ~ 1,
      C_MED2 == 1                            ~ 1,
      is.na(tg_dec_w4) & is.na(C_MED2)       ~ NA_real_,
      TRUE                                   ~ 0
    ),
    
    # HDL: bottom 3 deciles (F), bottom 2 deciles (M) or diagnosed ~ 1
    # else if missing HDL ~ NA
    # else ~ 0
    mets_hdl = NA_real_,
    mets_hdl = case_when(
      dx_hc_w4 == 1                          ~ 1, 
      as.double(BIO_SEX4) == 1 & hdl_dec_w4 %in% c(1:2) ~ 1,
      as.double(BIO_SEX4) == 2 & hdl_dec_w4 %in% c(1:3) ~ 1,
      is.na(hdl_dec_w4)                      ~ NA_real_,
      TRUE                                   ~ 0
    ),
    
    # HBA1C >= 5.7% or taking anti diabetes medication or diagnosed ~ 1
    # else if missing either hb1ac_pct or C_MED ~ NA_real_
    # else ~ 0
    mets_hba1c = NA_real_,
    mets_hba1c = case_when(
      hba1c_pct_w4 >= 5.7   | C_MED == 1   | dx_hbs_w4 == 1 ~ 1,
      is.na(hba1c_pct_w4)   | is.na(C_MED)                  ~ NA_real_,
      TRUE                                                  ~ 0
    ),
  )

w4 <- w4 %>% 
  select(!TG) %>% 
  select(!HDL) %>% 
  select(!HBA1C) 
```

## Create mets binary classification: Any 3 of 5 mets components
```{r}
w4 <- w4 %>%
  mutate(
    mets_w4 = NA_real_,
    mets_w4 = case_when(
      rowSums(.[grep("mets_", names(w4))], na.rm = T) >= 3        ~ 1,
      rowSums(.[grep("mets_", names(w4))], na.rm = T) <  3 &
        apply(.[grep("mets_", names(w4))], 1, function(x)
          anyNA(x)) ~ NA_real_,
      TRUE                                                        ~ 0
    ),
    mets_w4 = factor(
      mets_w4,
      levels = c(0,1),
      labels = c("No metabolic syndrome",
                 "Metabolic syndrome")
    )
  )

# Change hypertension component to factor
 w4 <- w4 %>% 
   mutate(
     mets_bp = factor(
       mets_bp,
       levels = c(0,1),
       labels = c("Not hypertensive",
                  "Hypertensive")
       )
   )
```
              
## Create unweighted Table 1 (as a test) 
```{r}
# label all variables 
table1::label(w4$BIO_SEX4) <- "Sex"
table1::label(w4$age_w4) <- "Age"
table1::label(w4$ace_emo_abu_w4) <- "ACE: Emotional neglect"
table1::label(w4$ace_par_inc_w4) <- "ACE: Family member incarceration"
table1::label(w4$dep_cts) <- "Depression (continuous)"
table1::label(w4$exp_dis_w4) <- "Experienced racial discrimination"
table1::label(w4$sbp_w4) <- "Systolic blood pressure"
table1::label(w4$dbp_w4) <- "Diastolic blood pressure"
table1::label(w4$ht_meds_w4) <- "Anti-hypertension medications"
table1::label(w4$dx_ht_w4) <- "Diagnosed hypertension"
table1::label(w4$waist_w4) <- "Waist circumference"
table1::label(w4$tg_dec_w4) <- "Triglyceride deciles"
table1::label(w4$C_MED2) <- "Anti-hyperlipid medications"
table1::label(w4$hdl_dec_w4) <- "HDL cholesterol deciles"
table1::label(w4$dx_hc_w4) <- "Diagnosed high cholesterol"
table1::label(w4$C_MED) <- "Anti-diabetes medications"
table1::label(w4$hba1c_pct_w4) <- "Glycated hemoglobin levels"
table1::label(w4$dx_hbs_w4) <- "Diagnosed diabetes"
table1::label(w4$pdu_w4) <- "Problematic drug use"
table1::label(w4$anx_w4) <- "Diagnosed anxiety"
table1::label(w4$mets_w4) <- "Metabolic syndrome"
table1::label(w4$mets_bp) <- "Hypertension (binary)"
table1::label(w4$ast_w4) <- "Diagnosed asthma"
units(w4$sbp_w4) <- "mmHg"
units(w4$dbp_w4) <- "mmHg"
units(w4$waist_w4) <- "cm"
units(w4$hba1c_pct_w4) <- "%"

# create table 1
table1(~ BIO_SEX4 + 
         age_w4 +
         ace_emo_abu_w4 + 
         ace_par_inc_w4 +
         dep_cts +
         exp_dis_w4 + 
         sbp_w4 + 
         dbp_w4 +
         ht_meds_w4 +
         dx_ht_w4 + 
         waist_w4 +
         tg_dec_w4 + 
         C_MED2 + 
         hdl_dec_w4 +
         dx_hc_w4 + 
         C_MED + 
         hba1c_pct_w4 +
         dx_hbs_w4 + 
         mets_w4, 
       data = w4 
       )
```
# write out csv
```{r}
write.csv(w4, "w4.csv")
```


### APPENDIX ###    
 
w4 <- w4 %>%
  mutate(
    # Education - reporting on self
    self_educ_cat_w4 = NA_real_,
    self_educ_cat_w4 = case_when(
      H4ED2 %in% c(1, 2, 4, 5)              ~ 1,  # same coding above
      H4ED2 == 3                            ~ 2,
      H4ED2 == 6                            ~ 3,
      H4ED2 %in% c(7, 8, 9, 10, 11, 12, 13) ~ 4,
      TRUE                                  ~ H4ED2
    ), # 98 -> NA
  
 
       
   # create alternative cardiovascular outcomes
       #w4 <- wave4 %>% 
          #mutate(
             #ebp_w4 = NA_real_,
             #ebp_w4 = case_when(
                #120 <= H4SBP <= 129 & H4DBP < 80 | H4ID5c == 1 ~ 1
                #TRUE ~ 0),
             #htn1_w4 = case_when(
                #130 <= H4SBP <= 139 & 80 <= H4DBP <= 89 | H4ID5c == 1 ~ 1
                #TRUE ~ 0),
             #htn2_w4 = NA_real_,
             #htn2_w4 = case_when(
                #H4SBP >= 140 | H4DBP >= 90 | H4ID5c == 1 ~ 1
                #TRUE ~ 0)
             #)

#------------------------------ DESCRIPTIVE DATA ------------------------------#
       
   # tables and visualizations of variable distributions and missingness
       
       # get table 1 of distribution of variables by race
       tab1 <- table1(~ factor(mis_w1) + factor(H1GI9) + factor(max_par_educ_cat_w1) +
                         PA55 + factor(self_educ_cat_w4) + factor(mets) | 
                         factor(single_race),
              data=ah, 
              overall="Total")
       
       
       tab3 <- table1(~ factor(mets_bp) + factor(mets_waist) + factor(mets_tg) + 
                         factor(mets_hdl) + factor(mets_hba1c) + factor(mets),
                      data=ah, 
                      overall="Total")
       
       # visualizing missingness
       vis_dat(ah, warn_large_data = F)
       gg_miss_upset(ah)
       
   # playing with data
       # what are multiracial people classified as in wave 1?
       w1_multi_class <- ah %>% 
          filter(single_race == 6) %>% 
          group_by(H1GI9, mis_w1) %>% 
          summarize(n = n())
       
       # get 2x2 tables of misclass & metS for monoracial and multiracial
       monor_2x2 <- ah %>% 
          filter(single_race != 6,
                 !is.na(mis_w1), 
                 !is.na(mets)) %>% 
          group_by(mis_w1, mets) %>% 
          summarize(n = n()) %>% 
          spread(mets, n)
       
       multir_2x2 <- ah %>% 
          filter(single_race == 6,
                 !is.na(mis_w1),
                 !is.na(mets)) %>% 
          group_by(mis_w1, mets) %>% 
          summarize(n = n()) %>% 
          spread(mets, n)
              

